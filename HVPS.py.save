# coding: utf-8 
# Interfacing with EMCO HVPS 
# From  Andrew Groll's Code and updated by Michael Cheng and Dan Strat
# Modified by Christian Zircher
import usb.core 
import usb.util 
import time 
import sys
# Constants
interface = 0 
configuration = 1
# Find Device
dev = usb.core.find(idVendor=0x03EB, idProduct=0x201D)
# Check for Device
if dev is None:
    raise ValueError("Device not found") 
if dev.is_kernel_driver_active(interface) is True:
    dev.detach_kernel_driver(interface) 

dev.set_configuration() 
cfg = dev.get_active_configuration()
intf = cfg[(0,0)] 
usb.util.claim_interface(dev, intf) 

ep = intf[1] 
assert ep is not None
#The Hex Decimal commands for 900V and 1000V have not been found yet.
answer = int(input("Enter a Voltage (100 - 800) in Increments of 100: "))
if answer is 100:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    
elif answer is 200:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #200 Volts
    ep.write([0x01,0x33,0x03,0x00,0x00,0x00,0x41,0x04])
    time.sleep(2)
    
elif answer is 300:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #200 Volts
    ep.write([0x01,0x33,0x03,0x00,0x00,0x00,0x41,0x04])
    time.sleep(2)
    #300 Volts
    ep.write([0x01,0xCC,0x04,0x00,0x00,0x00,0x43,0x04])
    time.sleep(2)
    
elif answer is 400:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #200 Volts
    ep.write([0x01,0x33,0x03,0x00,0x00,0x00,0x41,0x04])
    time.sleep(2)
    #300 Volts
    ep.write([0x01,0xCC,0x04,0x00,0x00,0x00,0x43,0x04])
    time.sleep(2)
    #400 Volts
    ep.write([0x01,0x66,0x06,0x00,0x00,0x04,0xCA,0x04])
    time.sleep(2)
    
elif answer is 500:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #200 Volts
    ep.write([0x01,0x33,0x03,0x00,0x00,0x00,0x41,0x04])
    time.sleep(2)
    #300 Volts
    ep.write([0x01,0xCC,0x04,0x00,0x00,0x00,0x43,0x04])
    time.sleep(2)
    #400 Volts
    ep.write([0x01,0x66,0x06,0x00,0x00,0x04,0xCA,0x04])
    time.sleep(2)
    #500 Volts
    ep.write([0x01,0xFF,0x07,0x00,0x00,0x00,0x18,0x04])
    time.sleep(2)
    
elif answer is 600:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #200 Volts
    ep.write([0x01,0x33,0x03,0x00,0x00,0x00,0x41,0x04])
    time.sleep(2)
    #300 Volts
    ep.write([0x01,0xCC,0x04,0x00,0x00,0x00,0x43,0x04])
    time.sleep(2)
    #400 Volts
    ep.write([0x01,0x66,0x06,0x00,0x00,0x04,0xCA,0x04])
    time.sleep(2)
    #500 Volts
    ep.write([0x01,0xFF,0x07,0x00,0x00,0x00,0x18,0x04])
    time.sleep(2)
    #600 Volts
    ep.write([0x01,0x99,0x09,0x00,0x00,0x07,0xFF,0x04])
    time.sleep(2)
    
elif answer is 700:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #200 Volts
    ep.write([0x01,0x33,0x03,0x00,0x00,0x00,0x41,0x04])
    time.sleep(2)
    #300 Volts
    ep.write([0x01,0xCC,0x04,0x00,0x00,0x00,0x43,0x04])
    time.sleep(2)
    #400 Volts
    ep.write([0x01,0x66,0x06,0x00,0x00,0x04,0xCA,0x04])
    time.sleep(2)
    #500 Volts
    ep.write([0x01,0xFF,0x07,0x00,0x00,0x00,0x18,0x04])
    time.sleep(2)
    #600 Volts
    ep.write([0x01,0x99,0x09,0x00,0x00,0x07,0xFF,0x04])
    time.sleep(2)
    #700 Volts
    ep.write([0x01,0x32,0x0B,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    
elif answer is 800:
    time.sleep(10)
    print("SENDING COMMANDS")
    # Enable EMCO
    print("ENABLE EMCO")
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(0.01)
    ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04])
    time.sleep(2)
    print("Set High Voltage ON")
    #100 Volts
    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #200 Volts
    ep.write([0x01,0x33,0x03,0x00,0x00,0x00,0x41,0x04])
    time.sleep(2)
    #300 Volts
    ep.write([0x01,0xCC,0x04,0x00,0x00,0x00,0x43,0x04])
    time.sleep(2)
    #400 Volts
    ep.write([0x01,0x66,0x06,0x00,0x00,0x04,0xCA,0x04])
    time.sleep(2)
    #500 Volts
    ep.write([0x01,0xFF,0x07,0x00,0x00,0x00,0x18,0x04])
    time.sleep(2)
    #600 Volts
    ep.write([0x01,0x99,0x09,0x00,0x00,0x07,0xFF,0x04])
    time.sleep(2)
    #700 Volts
    ep.write([0x01,0x32,0x0B,0x00,0x00,0x00,0x50,0x04])
    time.sleep(2)
    #800 Volts
    ep.write([0x01,0xCC,0x0C,0x00,0x00,0x0B,0x31,0x04])
    time.sleep(2)
#Don't use this part yet! I have not found the Hex Decimal command for 900V and 1000V 
#yet. elif answer is 900:
#    time.sleep(10) print("SENDING COMMANDS")
#    # Enable EMCO
#    print("ENABLE EMCO") ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04]) 
#    time.sleep(0.01) ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04]) 
#    time.sleep(2) print("Set High Voltage ON")
#    #900 Volts
#    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04]) time.sleep(2)
    
#elif answer is 1000:
#    time.sleep(10) print("SENDING COMMANDS")
#    # Enable EMCO
#    print("ENABLE EMCO") ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04]) 
#    time.sleep(0.01) ep.write([0x02,0x80,0xCC,0x00,0x00,0x0F,0xFF,0x04]) 
#    time.sleep(2) print("Set High Voltage ON")
#    #1000 Volts
#    ep.write([0x01,0x99,0x01,0x00,0x00,0x00,0x50,0x04]) time.sleep(2)

answer2 = int(input("Type '0' to Shutdown HVPS: "))
    
if answer2 is 0:
    print("Set High Voltage OFF")
    ep.write([0x01,0x00,0x00,0x00,0x00,0x01,0x98,0x04])
    time.sleep(60)
    # Disable EMCO
    print("DISABLE EMCO")
    ep.write([0x02,0x00,0xCC,0x00,0x00,0x00,0x48,0x04])
usb.util.release_interface(dev, intf)
